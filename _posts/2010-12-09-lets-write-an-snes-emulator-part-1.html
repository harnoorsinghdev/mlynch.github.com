--- 
layout: post
title: Let's write an SNES emulator - Part 1
published: true
meta: 
  posterous_60e8ef2b7d9ddd23e14a941a8878b49c_post_id: "35795854"
  posterous_60e8ef2b7d9ddd23e14a941a8878b49c_permalink: http://maxlynchmadison.posterous.com/lets-create-an-snes-emulator-part-1
tags: []

type: post
status: publish
---

    <p>I recently moved back to Madison, Wisconsin and started a job at the social and mobile gaming company <a href="http://perblue.com">Perblue</a>.&nbsp; I've had a ton of free time on my hands considering I'm not running my startup anymore, so I've decided to take on a few new projects.<p />  Developing an SNES emulator has always been a goal of mine especially since I love playing SNES games (Super Metroid is by far one of my favorite games ever and I play it to this day, though usually just through mods like Super Metroid Redesign) and writing an emulator is a technical challenge that draws from a lot of areas that I don't exercise as a web developer and don't have much experience in.<p />  I decided to publish this series in case anyone else wanted to learn how to make an emulator along side me.&nbsp; I'll try to publish my findings and improvements every few days and share a github repo with my current code.&nbsp; On that note, let's jump right in!<p /> </p>
<h3>Day 1: Reading SNES ROM Headers</h3>
<p>Today I started with a ROM that I found and figured the best place to start was to read the data in the ROM file.&nbsp; The first place to start when reading binary formats is the header which often describes the data in the rest of the file. ROM Hack City has some good articles on reading ROM headers.&nbsp; I found out that some ROMs have what is called an SMC header.&nbsp; It seems this header is added by whatever system created an image of the ROM and is not actually present on the cartridge.&nbsp; The main impact this has on us is we have to know if we should tack on 512 bytes to process in the beginning.&nbsp; If you don't mind the header you will end up with bad offsets into the ROM down the road.&nbsp; ROM Hack City has some good articles on the SMC headers for headered ROMs (<a href="http://romhack.wikia.com/wiki/SMC_header" class="moz-txt-link-freetext">http://romhack.wikia.com/wiki/SMC_header</a>).&nbsp; Not all ROMs have the header so the basic check to see if yours does is to take the complete size of the ROM file and divide it by 1024.&nbsp; If the remainder is equal to 512 your ROM has a header.&nbsp; If it is zero or otherwise it doesn't.<p />  Next you have to read the SNES header of the ROM that all ROMs have.&nbsp; The easiest way to know if you are reading the correct part of the ROM is to see if you correctly read in the 21 bytes of the rom name.&nbsp; If you don't see something like "Super Metroid" you aren't reading the right location!&nbsp; Again, ROM Hack City has a good explanation of the SNES header: <a href="http://romhack.wikia.com/wiki/SNES_header" class="moz-txt-link-freetext">http://romhack.wikia.com/wiki/SNES_header</a>.&nbsp; There are a ton of fields in the SNES header and their functionality will surely become more clear to me as I go along.<p />  I am doing this project in C, and in C it's super easy to read a chunk of a file into a structure and then access the data using the fields in the structure using fread().&nbsp; Some of the fields in both the SMC and the SNES headers are packed into 4-bit values, meaning you will have to do some bit masking to properly pull out the values in the 8-bit field.&nbsp; However, I think it's okay to just read in the whole value and then do the masks later once you need those values.<p />  The next step is a little unclear for me and will require a bit more research.&nbsp; My initial thought was to try to find the location of the first instruction in the ROM file and try to disassemble the instructions to make sure I'm doing it correctly before I build a 65186 emulator.&nbsp; I've started writing a very basic disassembler but I'm not sure what the instruction size (16-bit?) or opcode sizes are so I don't know when to delimit each instruction.<p />  I am doing this project in C (with a hint of ++) using Visual Studio 2010.&nbsp; I'm trying to make the program as portable as possible but most ROM tools seem to be built for Windows so I'm not sure if developing the emulator on Linux and then going through the trouble of porting the build to Windows later on is worth the pain.<p />  If you have any suggestions, comments, or want to join in, feel free to leave a comment below!<p />  The github repo is here and reflects a few hours of work today: <a href="https://github.com/mlynch/supernintenbro" class="moz-txt-link-freetext">https://github.com/mlynch/supernintenbro</a></p>
  
